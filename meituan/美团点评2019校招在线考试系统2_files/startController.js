app.register("startController",["$scope","$http","$state","$location","$timeout","App",function($scope,$http,$state,$location,$timeout,App){$timeout(function(){$("#navTab").show();selTab("start");$.cxDialog.close()});$scope.App=App;window.scrollTo(0,0);$scope.loading=false;$scope.model={};window.ACMGlobal.submit=true;window.ACMGlobal.submitPaper=[];$scope.refreshFunc=function(){$scope.loading=true;$http.post("/cand/api/papersExact",$scope.model).success(function(data){window.positionId=data.positionId;data=data.data;if(App.checkData(data,$state)){if(data[0].rigidStartTime!=undefined){window.ACMGlobal.timeType=1}App.Papers=$scope.model.Papers=data;$scope.model.randPaper=[];$scope.model.routinePaper=[];$scope.model.tagPaper=[];$scope.model.Papers.forEach(function(paper){if(paper.randPaper!=undefined){$scope.model.randPaper.push(paper)}else if(paper.tag!=undefined){$scope.model.tagPaper.push(paper)}else{$scope.model.routinePaper.push(paper)}if(paper.fenzhi!=="--"){paper.fenzhi=parseFloat(paper.fenzhi).toFixed(1)}});if($scope.model.tagPaper.length>0){var tagList=[];for(var i=0;i<$scope.model.tagPaper.length;i++){for(var j=0;j<$scope.model.tagPaper[i].tag.length;j++){var isExit=false;for(var k=0;k<tagList.length;k++){if(tagList[k].tag==$scope.model.tagPaper[i].tag[j]){tagList[k].papers.push($scope.model.tagPaper[i]);isExit=true}}if(!isExit){var ps=[];ps.push($scope.model.tagPaper[i]);tagList.push({tag:$scope.model.tagPaper[i].tag[j],papers:ps})}}}for(var i=0;i<tagList.length;i++){tagList[i].time=0;for(var j=0;j<tagList[i].papers.length;j++){tagList[i].time+=tagList[i].papers[j].allTime}}tagList.forEach(function(item){if(item.tag!=undefined&&item.tag!=""){item.sortBy=item.tag.substring(0,1)}});var newTagList=[];for(var i=65;i<91;i++){for(var j=0;j<tagList.length;j++){if(tagList[j].sortBy!=undefined&&tagList[j].sortBy.charCodeAt()==i){newTagList.push(tagList[j])}}}$scope.model.tagList=newTagList}for(var i=0;i<data.length;i++){App.savePaper(data[i]);(function(idx){$http.post("/cand/api/papersQuestion",{positionId:positionId,paperId:$scope.model.Papers[idx]._id}).success(function(ques){if(App.checkData(ques,$state)){if(Object.isArray(ques)){if(ques.length>0){for(var j=0;j<ques.length;j++){var saveStatus=false;try{ques[j].ques.questitle=ques[j].ques.questitle.replace(/http:\/\/cdn.acmcoder.com/g,"https://cdn.acmcoder.com");if(window.ACMGlobal.imgLoaded!=undefined&&ques[j].ques!=undefined&&ques[j].ques.questitle!=undefined&&$("<div>"+ques[j].ques.questitle+"</div>").find("img").length>0){for(var m=0;m<$("<div>"+ques[j].ques.questitle+"</div>").find("img").length;m++){window.ACMGlobal.imgLoaded($($("<div>"+ques[j].ques.questitle+"</div>").find("img")[m]).attr("src"),function(){})}}if(window.ACMGlobal.imgLoaded!=undefined&&ques[j].ques!=undefined&&ques[j].ques.options!=undefined&&ques[j].ques.options.length>0){for(var m=0;m<ques[j].ques.options.length;m++){ques[j].ques.options[m].opttitle=ques[j].ques.options[m].opttitle.replace(/http:\/\/cdn.acmcoder.com/g,"https://cdn.acmcoder.com");if(ques[j].ques.options[m]!=undefined&&ques[j].ques.options[m].opttitle!=undefined&&$("<div>"+ques[j].ques.options[m].opttitle+"</div>").find("img").length>0){for(var k=0;k<$("<div>"+ques[j].ques.options[m].opttitle+"</div>").find("img").length;k++){window.ACMGlobal.imgLoaded($($("<div>"+ques[j].ques.options[m].opttitle+"</div>").find("img")[k]).attr("src"),function(){})}}}}}catch(e){}if(ques[j].fileUrl!=undefined&&ques[j].fileUrl!=""){App.saveQues($scope.model.Papers[idx]._id,ques[j],true)}else{App.saveQues($scope.model.Papers[idx]._id,ques[j])}}}else{if(window.ACMGlobal.timeType!=1){$.cxDialog({title:ACM.lang.hint,background:"#000",closeBtn:false,width:400,info:'<div class="Bigshowtip" style="padding: 20px 30px 20px;text-align: center;font-size:16px;">'+ACM.lang.start.noPrepare+"</div>",ok:function(){gotoHash("#/main/rules")},okText:ACM.lang.iknow})}}}}else{}}).error(function(data){console.log("Error: "+data)})})(i)}$http.post("/cand/api/CandsState",{r:Math.random()}).success(function(cs){$scope.model.CandsState=cs;if(cs!=null&&cs.submit==true){}else{var blSubmit=true;for(var i=0;i<data.length;i++){if(data[i].quesNum>data[i].answers&&(data[i].randPaper==undefined&&data[i].tag==undefined)){blSubmit=false;break}else if(data[i].randPaper!=undefined){var isExit=false;if($scope.model.CandsState.choosePaperIds!=undefined){for(var j=0;j<$scope.model.CandsState.choosePaperIds.length;j++){if(data[i]._id==$scope.model.CandsState.choosePaperIds[j]){isExit=true}}}if(isExit&&data[i].quesNum>data[i].answers){blSubmit=false;break}}else if(data[i].tag!=undefined){if($scope.model.CandsState.choosePaper!=undefined){var isExit=false;for(var j=0;j<data[i].tag.length;j++){if($scope.model.CandsState.choosePaper==data[i].tag[j]){isExit=true}}if(isExit&&data[i].quesNum>data[i].answers){blSubmit=false;break}}}}if(!blSubmit){var stext=ACM.lang.start.noCompleteSubmit;$("#submitmodal .info").html(stext);if(whenSubmitPapers){whenSubmitPapers($scope.model.Papers)}}else{$("#submitmodal .info").html(ACM.lang.start.completeSubmit)}for(var i=0;i<data.length;i++){if(data[i].answerType==true&&data[i].submit!=true){if($scope.model.CandsState.choosePaper!=undefined){if(data[i].tag!=undefined){var isExit=false;for(var j=0;j<data[i].tag.length;j++){if(data[i].tag[j]==$scope.model.CandsState.choosePaper){isExit=true}}if(isExit){window.ACMGlobal.submit=false;window.ACMGlobal.submitPaper.push(data[i].title)}}else{window.ACMGlobal.submit=false;window.ACMGlobal.submitPaper.push(data[i].title)}}else{window.ACMGlobal.submit=false;window.ACMGlobal.submitPaper.push(data[i].title)}}}}}).error(function(data){console.log("Error: "+data)})}else{$scope.model.Papers=null}$scope.loading=false}).error(function(data){console.log("Error: "+data);$scope.loading=false})};$scope.getpaperQuestion=function(mt){$http.post("/cand/api/rigidPapersQuestion",{positionId:positionId,paperId:mt._id}).success(function(data){var ques=data.result;if(App.checkData(ques,$state)){if(Object.isArray(ques)){if(ques.length>0){for(var j=0;j<ques.length;j++){var saveStatus=false;if(ques[j].fileUrl!=undefined&&ques[j].fileUrl!=""){App.saveQues(mt._id,ques[j],true)}else{App.saveQues(mt._id,ques[j])}try{App.updateFromServer($http,$state);if(mt.forCode){var clientWidth=window.innerWidth;if(clientWidth<800){clientWidth=clientWidth-40;$.cxDialog({title:ACM.lang.hint,width:clientWidth,background:"#000",info:'<div style="padding:20px; text-align:center;">'+ACM.lang.start.codeForMobile+"</div>",ok:function(){},okText:ACM.lang.iknow})}else{gotoHash("#/main/onlinecode/{0}/{1}/{2}".Format(mt._id,-1,1))}}else if(mt.forOXCoder){gotoHash("#/main/prj/{0}/{1}/{2}".Format(mt._id,-1,1))}else{gotoHash("#/main/answer/{0}/{1}/{2}".Format(mt._id,-1,1))}}catch(e){}}}}}else{}}).error(function(data){console.log("Error: "+data)})};$scope.refreshFunc();$scope.submitTip=function(){if($scope.App.serverTime.usedTime<5*60){cxalert(ACM.lang.hint,ACM.lang.start.fiveSubmit);return}if(window.submitTimer){window.clearInterval(window.submitTimer)}$(this).attr("href","javascript:void(0)");var mytxt=$("#submitmodal .info").html();if($scope.App.myInfo.timeType==1){$.cxDialog({title:ACM.lang.hint,width:450,background:"#000",info:'<div class="showtip"><table align="center"><tbody><tr><td><i class="fa fa-exclamation-triangle"></i></td><td><span class="fbig fb"></span>'+ACM.lang.start.completeSubmit+"</td></tr></tbody></table></div>",ok:function(){window.clearInterval(window.submitTimer)},okText:ACM.lang.no,no:function(){$http.post("/cand/api/submit",{r:Math.random()}).success(function(cs){$.get("/cand/logout",{c:1},function(){});$http.post("/cand/api/addLog",{action:"submit"}).success(function(data){location.href="http://cdn.acmcoder.com/release/exam/1.2.4/htmls/exam/endexam.html"}).error(function(data){location.href="http://cdn.acmcoder.com/release/exam/1.2.4/htmls/exam/endexam.html"})}).error(function(data){console.log("Error: "+data)})},noText:ACM.lang.ok+" （5s）"});$(".cxdialog .btn_no").addClass("limited");var submitInt=5;window.submitTimer=window.setInterval(function(){if(submitInt>1){submitInt--;$(".cxdialog .btn_no").html(ACM.lang.ok+" （"+submitInt+"s）")}else{window.clearInterval(window.submitTimer);$(".cxdialog .btn_no").html(ACM.lang.ok);$(".cxdialog .btn_no").removeClass("limited")}},1e3)}else{if(window.ACMGlobal.submit){$.cxDialog({title:ACM.lang.hint,width:450,background:"#000",info:'<div class="showtip"><table align="center"><tbody><tr><td><i class="fa fa-exclamation-triangle"></i></td><td><span class="fbig fb"></span>'+mytxt+"</td></tr></tbody></table></div>",ok:function(){window.clearInterval(window.submitTimer)},okText:ACM.lang.no,no:function(){if(!$(".cxdialog .btn_no").hasClass("limited")){if(!$("#submitTip").hasClass("wsp")){$http.post("/cand/api/addLog",{action:"submit"}).success(function(data){$http.post("/cand/api/submit",{r:Math.random()}).success(function(cs){location.href="http://cdn.acmcoder.com/release/exam/1.2.4/htmls/exam/endexam.html"}).error(function(data){console.log("Error: "+data)})}).error(function(data){$http.post("/cand/api/submit",{r:Math.random()}).success(function(cs){location.href="http://cdn.acmcoder.com/release/exam/1.2.4/htmls/exam/endexam.html"}).error(function(data){console.log("Error: "+data)})})}}else{return false}},noText:ACM.lang.ok+" （5s）"});$(".cxdialog .btn_no").addClass("limited");var submitInt=5;window.submitTimer=window.setInterval(function(){if(submitInt>1){submitInt--;$(".cxdialog .btn_no").html(ACM.lang.ok+" （"+submitInt+"s）")}else{window.clearInterval(window.submitTimer);$(".cxdialog .btn_no").html(ACM.lang.ok);$(".cxdialog .btn_no").removeClass("limited")}},1e3)}else{cxalert(ACM.lang.hint,'<div style="max-width:300px;">'+window.ACMGlobal.submitPaper.join("，")+ACM.lang.start.needComplete+"</div>")}}};$scope.chooisePaperAB=function(tl){$.cxDialog({title:ACM.lang.hint,width:450,background:"#000",info:'<div style="text-align: center; padding: 20px;font-size:16px; font-weight:bold;color:#6d6d6d">'+ACM.lang.start.chooisePaper+"</div>",ok:function(){window.clearInterval(window.chooiseTimer)},okText:ACM.lang.thinkAgain,no:function(){if(!$(".cxdialog .btn_no").hasClass("limited")){window.clearInterval(window.chooiseTimer);$http.post("/cand/api/setCandPaerAB",{prjId:App.myInfo.prjId,tag:tl.tag}).success(function(data){if(data==1){$scope.App.myInfo.choosePaper=tl.tag}else{cxalert(ACM.lang.hint,ACM.lang.start.operationError)}}).error(function(data){console.log("Error: "+data)})}else{return false}},noText:ACM.lang.start.confirmSubmit+" （3s）"});$(".cxdialog .btn_no").addClass("limited");var submitInt=3;window.chooiseTimer=window.setInterval(function(){if(submitInt>1){submitInt--;$(".cxdialog .btn_no").html(ACM.lang.start.confirmSubmit+" （"+submitInt+"s）")}else{window.clearInterval(window.chooiseTimer);$(".cxdialog .btn_no").html(ACM.lang.start.confirmSubmit);$(".cxdialog .btn_no").removeClass("limited")}},1e3)};$scope.prjPromptGet=function(){$http.post("/cand/api/prjPrompt",{}).success(function(data){if(App.checkData(data,$state)){$scope.model.prjPrompt=data}else{$scope.model.prjPrompt=""}$scope.loading=false}).error(function(data){console.log("Error: "+data);$scope.loading=false})};$scope.prjPromptGet();$scope.start=function(mt,pIndex){var blNext=true;if(beforeEnterPaper){blNext=beforeEnterPaper(mt,$scope.model.Papers,pIndex)}if(App.myInfo.openType!=undefined&&(App.myInfo.openType===0||App.myInfo.openType==="0")&&mt.randPaper==undefined&&mt.tag==undefined){var paper=mt;var papers=$scope.model.routinePaper;if(pIndex>0){if(papers[pIndex-1].submit==true){blNext=true}else{if(ACMGlobal.timeType==1&&Date.parse(papers[pIndex-1].rigidEndTime)+user.vipCode*1e3<Date.now()){blNext=true}else if(ACMGlobal.timeType==1&&Date.parse(papers[pIndex-1].rigidEndTime)+user.vipCode*1e3>Date.now()){cxalert(ACM.lang.hint,ACM.lang.start.answerPrvPaper);blNext=false}else{cxalert(ACM.lang.hint,ACM.lang.start.answerPrvPaper);blNext=false}}}else{blNext=true}}else if(App.myInfo.openType!=undefined&&(App.myInfo.openType===0||App.myInfo.openType==="0")&&(mt.randPaper!=undefined||mt.tag!=undefined)){if($scope.model.routinePaper[$scope.model.routinePaper.length-1]!=undefined&&$scope.model.routinePaper[$scope.model.routinePaper.length-1].submit!=true){cxalert(ACM.lang.hint,ACM.lang.start.answerPrvPaper);blNext=false;return}}if(mt.randPaper!=undefined){var answerdPaperNum=1;var answerdPaperArr=[];$scope.model.randPaper.forEach(function(paper){if(paper.submit==true||paper.answers>0){answerdPaperNum++;answerdPaperArr.push(paper._id)}});var limitedPapaerNum=$scope.model.randPaper[0].randPaper;if(mt.answers>0||mt.submit==true){if(blNext){$http.post("/cand/api/choosePaperIds",{paperIds:answerdPaperArr.join(",")}).success(function(data){}).error(function(data){});$scope.interFun(mt,pIndex)}$.cxDialog.close()}else{if(parseInt(limitedPapaerNum)>=answerdPaperNum){var confirmTip="";if(ACM.lang.lang=="en"){confirmTip=ACM.lang.start.chooisePaperNum1+answerdPaperNum+ACM.lang.start.chooisePaperNum2}else{confirmTip=ACM.lang.start.chooisePaperNum1+answerdPaperNum+ACM.lang.start.chooisePaperNum2}cxConfirm(confirmTip,function(){if(blNext){answerdPaperArr.push(mt._id);$http.post("/cand/api/choosePaperIds",{paperIds:answerdPaperArr.join(",")}).success(function(data){}).error(function(data){});$scope.interFun(mt,pIndex)}$.cxDialog.close()})}else{cxalert(ACM.lang.hint,ACM.lang.start.hasChooise1+limitedPapaerNum+ACM.lang.start.hasChooise2)}}}else{if(blNext){$scope.interFun(mt,pIndex)}}};window.showPaperCountDown=function(){window.ACM.leftSecs--;if(window.ACM.leftSecs>0){var mins=parseInt(window.ACM.leftSecs/60);var secs=parseInt(window.ACM.leftSecs-mins*60);if(ACM.lang.lang!="en"){cxalertBack(ACM.lang.hint,ACM.lang.start.waitPaperAns1+'<span style="font-size:18px;font-weight:bold;color: #ff8a00;">'+mins+"分"+secs+"秒</span>"+ACM.lang.start.waitPaperAns2,function(){window.clearInterval(window.showPaperCountDownTimer);$.cxDialog.close()})}else{cxalertBack(ACM.lang.hint,ACM.lang.start.waitPaperAns,function(){window.clearInterval(window.showPaperCountDownTimer);$.cxDialog.close()})}}else{window.clearInterval(window.showPaperCountDownTimer);cxalert(ACM.lang.hint,ACM.lang.start.timeArrivd)}};$scope.enterPaperCountDownTimer=function(mt){window.ACM.leftSecs=parseInt((Date.parse(mt.rigidStartTime)+user.vipCode*1e3-Date.now())/1e3);window.clearInterval(window.showPaperCountDownTimer);showPaperCountDown();window.showPaperCountDownTimer=window.setInterval("showPaperCountDown()",1e3)};$scope.interFun=function(mt,pIndex){$http.post("/cand/api/addLog",{action:"enterPaper",paperId:mt._id}).success(function(data){}).error(function(data){});$http.post("/cand/api/enterPaperNow",{r:Math.random(),paperId:mt._id,rowNumber:0,positionId:App.myInfo.positionId}).success(function(data){if(!isNaN(data)&&data==0){if(window.ACMGlobal.timeType==1){$scope.getpaperQuestion(mt)}else{App.updateFromServer($http,$state);if(mt.forCode){var clientWidth=window.innerWidth;if(clientWidth<800){clientWidth=clientWidth-40;$.cxDialog({title:ACM.lang.hint,width:clientWidth,background:"#000",info:'<div style="padding:20px; text-align:center;">'+ACM.lang.start.codeForMobile+"</div>",ok:function(){},okText:ACM.lang.iknow})}else{gotoHash("#/main/onlinecode/{0}/{1}/{2}".Format(mt._id,-1,1))}}else if(mt.forOXCoder){gotoHash("#/main/prj/{0}/{1}/{2}".Format(mt._id,-1,1))}else{gotoHash("#/main/answer/{0}/{1}/{2}".Format(mt._id,-1,1))}}}else if(!isNaN(data)&&data==-80){if($scope.App.myInfo.candType==1){$scope.getpaperQuestion(mt)}else{if(Date.parse(mt.rigidStartTime)+user.vipCode*1e3>Date.now()){$scope.enterPaperCountDownTimer(mt)}else if(Date.parse(mt.rigidEndTime)+user.vipCode*1e3<Date.now()){cxalert(ACM.lang.hint,ACM.lang.start.sorryLate)}else{cxalert(ACM.lang.hint,ACM.lang.start.waitORlate)}}}else if(!isNaN(data)&&data==-81){cxalert(ACM.lang.hint,ACM.lang.start.notAllowedEdit)}else if(!isNaN(data)&&data==-82){if($scope.App.myInfo.candType==1){cxalert(ACM.lang.hint,ACM.lang.start.prevPaperNotSubmit)}else{App.updateFromServer($http,$state);if(mt.forCode){var clientWidth=window.innerWidth;if(clientWidth<800){clientWidth=clientWidth-40;$.cxDialog({title:ACM.lang.hint,width:clientWidth,background:"#000",info:'<div style="padding:20px; text-align:center;">'+ACM.lang.start.codeForMobile+"</div>",ok:function(){},okText:ACM.lang.iknow})}else{gotoHash("#/main/onlinecode/{0}/{1}/{2}".Format(mt._id,-1,1))}}else if(mt.forOXCoder){gotoHash("#/main/prj/{0}/{1}/{2}".Format(mt._id,-1,1))}else{gotoHash("#/main/answer/{0}/{1}/{2}".Format(mt._id,-1,1))}}}else{cxalert(ACM.lang.hint,ACM.lang.start.busyWait)}}).error(function(data){})}}]);