var liveNessResultT=null;$(document).ready(function(){if(ACMGlobal.faceRecognition==true||ACMGlobal.faceRecognition=="1"){$(".innerInfo .stepinfo .tip .title").html("系统通过人脸识别技术，结合考试全程监拍，验证考生身份，确保考试的公平、公正");$(".ifh5").html('<span style="font-weight:bold;">提示：</span><br />1、请注意系统文字和声音的指令，缓慢做相应动作，进行人脸识别图像采集；<br />2、脸部光线不要太暗。<span style="color: #ff0000;font-weight:bold;font-size: 15px;">【秘技】背后如有高亮的光源，<span style="text-decoration: underline;">可将摄像头抬高，仰角45度，从上往下拍照；</span></span> <br />3、整场答题时，确保脸部在摄像头监拍范围，清晰可见。');if(location.protocol!="https:"){$(".ifh5").append('<br />4、Flash Player过期遭阻止？<a href="https://fpdownload.macromedia.com/pub/flashplayer/updaters/23/flashplayer_23_ppapi_debug.exe" target="_blank">点此更新Flash</a>')}$("#showc a").html("进入身份验证");$("#showc a").attr("style","")}else{}try{liveNessResultT=window.setInterval("getLiveNessResult()",1e3)}catch(e){}getLiveNessResult();if(!$.cookie("livenessLimited")){$.cookie("livenessLimited","10")}});function doLiveNess(){$.cxDialog({title:"提示",info:'<div class="showtip"><table align="center"><tbody><tr><td><i class="fa fa-exclamation-circle"></i></td><td><span class="fbig fb"></span>亲，<br>如由于人多导致网页打不开，有两种解决方案：<br>1、点击浏览器左侧返回按钮，进入考试页面，再点击最下方按钮右侧的“下一步”<br>2、退出，重新登录考试系统！</td></tr></tbody></table></div>',ok:function(){doLiveNessDo()},okText:"我知道了"})}function doLiveNessDo(){if(typeof top.ACMGlobal.kaoQian=="boolean"){cxalert("提示","开考前10分钟停止使用活体验证，请检查系统允许访问摄像头，开启监控。");top.window.initPhotoShow();$(".monitorBox").addClass("heightLimited")}else if(parseInt($.cookie("livenessLimited"))<1){cxalert("提示","您使用身份验证次数到限制啦，可以直接进行下一步了！<br> 请检查系统允许访问摄像头，开启监控。");top.window.initPhotoShow();$(".monitorBox").addClass("heightLimited")}else{if(typeof ACMGlobal.idcard!="undefined"&&ACMGlobal.idcard!=""&&typeof ACMGlobal.realName!="undefined"&&ACMGlobal.realName!=""){var url="/cand/api/getLiveToken/1?returnurl="+window.location.origin+"/cand/index"+"&returnurl_ext=/main/myPhoto&r="+Math.random();$.get(url,function(result){var data=$.parseJSON(result);if(typeof data.token!="undefined"){var token=data.token;$.cookie("livenessLimited",parseInt($.cookie("livenessLimited"))-1);document.location.href="https://api.megvii.com/faceid/liveness/v2/do?token="+token}else{var alertHtml="未知错误，请稍后重新尝试！";if(typeof data.error_message!="undefined"){if(data.error_message.indexOf("CONCURRENCY_LIMIT_EXCEEDED")>-1){alertHtml="系统正在玩命进行人脸识别身份验证，排队的人稍多，请稍后再试…  <br>如果即将开考，可以不进行身份验证，点击下方的“下一步”，直接开始答题！"}}$.cxDialog({title:"提示",info:'<div class="liveNessResult">'+alertHtml+"</div>",ok:function(){top.window.initPhotoShow();$(".monitorBox").addClass("heightLimited")},okText:"开启监拍",noText:"重新身份验证",no:function(){if(liveNessResultT==null){liveNessResultT=window.setInterval("getLiveNessResult()",1e3)}doLiveNessDo()}});ACMGlobal.liveNessResult=false}})}}}function getLiveNessResult(){var cishuTip="";if($.cookie("livenessLimited")&&parseInt($.cookie("livenessLimited"))>=0){cishuTip='<div class="smalltip">剩余验证次数：<span>'+$.cookie("livenessLimited")+"</span></div>"}if(ACMGlobal.faceRecognition==true||ACMGlobal.faceRecognition=="1"){$("#showc a").attr("style","")}else{$("#showc a").attr("style","left: 335px;")}if((typeof ACMGlobal.liveNessResult=="undefined"||typeof ACMGlobal.liveNessResult=="object")&&top.location.hash.indexOf("myPhoto")>-1&&typeof ACMGlobal.candId!="undefined"&&(ACMGlobal.faceRecognition==true||ACMGlobal.faceRecognition=="1")&&(top.isJianpai==false||typeof top.isJianpai=="undefined")){console.log("get liveness result...");$.get("/cand/api/getLiveNotifyResult",function(data){console.log(data);if(data.success){var mobileHtml="";if(typeof ACMGlobal.mobile!="undefined"){mobileHtml="<div>手机号："+ACMGlobal.mobile+"</div>"}var verifyresult=data.verify_result;if(data.success==true){if(data.result=="success"){if(typeof verifyresult.error_message=="undefined"){if(typeof verifyresult.result_faceid!="undefined"||typeof verifyresult.result_faceid.confidence!="undefined"){var confidence=verifyresult.result_faceid.confidence;var resultHtml="";var thresholds=verifyresult.result_faceid.thresholds["1e-3"];if(parseFloat(confidence)>=parseFloat(thresholds)){$.post("/cand/api/faceResult",{result:1},function(){});resultHtml='<div class="liveNessResult"><div>您的身份验证结果为：<span class="blue">已通过</span></div><div>考生姓名：'+ACMGlobal.realName+"</div>"+mobileHtml+"<div>身份证号："+ACMGlobal.idcard+"</div>"+'<div class="tip">注意：整场答题时，确保脸部在摄像头监拍范围，清晰可见，系统会全程监拍！</div>'+cishuTip+"</div>";$(".toolguider .next.nextstep").html("确认无误，下一步");$(".toolguider .next").bind("click",function(){gotoHash("#/main/rules")});$(".toolguider").removeClass("limited")}else{$.post("/cand/api/faceResult",{result:0},function(){});resultHtml='<div class="liveNessResult"><div>您的身份验证结果为：<span class="red">未通过</span></div><div>考生姓名：'+ACMGlobal.realName+"</div>"+mobileHtml+"<div>身份证号："+ACMGlobal.idcard+"</div>"+'<div style="padding:10px 0px;">您可以继续作答试题。考试结束后，我们会人工比对照片，如果确实是您本人，将不会影响考试成绩！</div><div  class="tip">注意：整场答题时，确保脸部在摄像头监拍范围，清晰可见，系统会全程监拍！</div>'+cishuTip+"</div>"}$.cxDialog.defaults.background="#000";$.cxDialog({title:"身份验证结果",info:resultHtml,ok:function(){top.window.initPhotoShow();$(".monitorBox").addClass("heightLimited")},okText:"开启监拍",noText:"重新身份验证",no:function(){if(liveNessResultT==null){liveNessResultT=window.setInterval("getLiveNessResult()",1e3)}doLiveNessDo()}});ACMGlobal.liveNessResult=true}else{$.cxDialog({title:"身份验证结果",info:'<div class="liveNessResult"><div>您的身份验证结果为：<span class="red">未通过</span></div><div>考生姓名：'+ACMGlobal.realName+"</div>"+mobileHtml+"<div>身份证号："+ACMGlobal.idcard+"</div>"+'<div style="padding:10px 0px;">您可以继续作答试题。考试结束后，我们会人工比对照片，如果确实是您本人，将不会影响考试成绩！</div><div  class="tip">注意：整场答题时，确保脸部在摄像头监拍范围，清晰可见，系统会全程监拍！</div>'+cishuTip+"</div>",ok:function(){top.window.initPhotoShow();$(".monitorBox").addClass("heightLimited")},okText:"开启监拍",noText:"重新身份验证",no:function(){if(liveNessResultT==null){liveNessResultT=window.setInterval("getLiveNessResult()",1e3)}doLiveNessDo()}});top.surenext3();ACMGlobal.liveNessResult=false}}else{$.cxDialog({title:"身份验证结果",info:'<div class="liveNessResult"><div>您的身份验证结果为：<span class="red">未通过</span></div><div>考生姓名：'+ACMGlobal.realName+"</div>"+mobileHtml+"<div>身份证号："+ACMGlobal.idcard+"</div>"+'<div style="padding:10px 0px;">您可以继续作答试题。考试结束后，我们会人工比对照片，如果确实是您本人，将不会影响考试成绩！</div><div  class="tip">注意：整场答题时，确保脸部在摄像头监拍范围，清晰可见，系统会全程监拍！</div>'+cishuTip+"</div>",ok:function(){top.window.initPhotoShow();$(".monitorBox").addClass("heightLimited")},okText:"开启监拍",noText:"重新身份验证",no:function(){if(liveNessResultT==null){liveNessResultT=window.setInterval("getLiveNessResult()",1e3)}doLiveNessDo()}});top.surenext3();ACMGlobal.liveNessResult=false}}else{$.cxDialog({title:"身份验证结果",info:'<div class="liveNessResult"><div style="font-weight:bold;">身份验证信息采集失败！请重新尝试！</div><div style="padding:20px 0px;">注意：<div>1、如果由于<span style="font-weight:bold;font-size:15px;">光线、摄像头、网速</span>等原因，导致<span style="font-weight:bold;font-size:15px;">人脸识别未验证</span>，可以<span style="font-weight:bold;font-size:15px;">正常进行作答</span>。</div><div>2、请务必打开下方“开启监拍”功能，考试全程会随机进行人脸识别身份验证，确保脸部在摄像区域中间。</div></div></div>',ok:function(){top.window.initPhotoShow();$(".monitorBox").addClass("heightLimited")},okText:"开启监拍",noText:"重新身份验证",no:function(){if(liveNessResultT==null){liveNessResultT=window.setInterval("getLiveNessResult()",1e3)}doLiveNessDo()}});ACMGlobal.liveNessResult=false}}var biz_id=data.bizid;if(typeof biz_id!="undefined"&&biz_id!=""){$.post("/cand/api/liveImage",{bizid:biz_id},function(result2){if(result2.success==true){var imgurl=result2.imgurl;var photoid=result2.photoid.$id;imgurl=imgurl.replace("http://","https://");if(typeof imgurl!="undefined"&&imgurl!=""){if(top.isJianpai&&top.cameratype=="swf"){if(imgurl.indexOf(".jpg")>-1||imgurl.indexOf(".jpeg")>-1||imgurl.indexOf(".png")>-1){$("#showphoto").attr("src",imgurl).attr("style","border: 0px; height: 273px;");top.surenext3()}else{imgurl=imgurl.replace("http://","https://");if(imgurl.indexOf("?")>-1){imgurl+="&v=1"}else{imgurl+="?v=1"}$.ajax({url:imgurl,type:"get",dataType:"text",success:function(imgdata){$("#showphoto").attr("src",imgdata).attr("style","border: 0px; height: 273px;");top.surenext3()},error:function(er){BackErr(er)}})}}else{if(imgurl.indexOf(".jpg")>-1||imgurl.indexOf(".jpeg")>-1||imgurl.indexOf(".png")>-1){$("#showphoto").attr("src",imgurl).attr("style","border: 0px;width: 364px; height: 273px;margin-left: -45px;");top.surenext3()}else{if(imgurl.indexOf("?")>-1){imgurl+="&v=1"}else{imgurl+="?v=1"}imgurl=imgurl.replace("http://","https://");$.ajax({url:imgurl,type:"get",dataType:"text",success:function(imgdata){$("#showphoto").attr("src",imgdata).attr("style","border: 0px;width: 364px; height: 273px;margin-left: -45px;");top.surenext3()},error:function(er){BackErr(er)}})}}$("#showc a").hide()}}else{$.cxDialog.defaults.background="#000";if(parseInt($.cookie("livenessLimited"))>0){$.cxDialog({title:"身份验证结果",info:'<div class="liveNessResult"><div>您的身份验证结果为：<span class="red">未通过</span></div><div>考生姓名：'+ACMGlobal.realName+"</div>"+mobileHtml+"<div>身份证号："+ACMGlobal.idcard+"</div>"+'<div style="padding:10px 0px;">您可以继续作答试题。考试结束后，我们会人工比对照片，如果确实是您本人，将不会影响考试成绩！</div><div  class="tip">注意：整场答题时，确保脸部在摄像头监拍范围，清晰可见，系统会全程监拍！</div>'+cishuTip+"</div>",ok:function(){top.window.initPhotoShow();$(".monitorBox").addClass("heightLimited")},okText:"开启监拍",noText:"重新身份验证",no:function(){if(liveNessResultT==null){liveNessResultT=window.setInterval("getLiveNessResult()",1e3)}doLiveNessDo()}});top.surenext3()}else{$.cxDialog({title:"身份验证结果",info:'<div class="liveNessResult"><div>您的身份验证结果为：<span class="red">未通过</span></div><div>考生姓名：'+ACMGlobal.realName+"</div>"+mobileHtml+"<div>身份证号："+ACMGlobal.idcard+"</div>"+'<div style="padding:10px 0px;">您可以继续作答试题。考试结束后，我们会人工比对照片，如果确实是您本人，将不会影响考试成绩！</div><div  class="tip">注意：整场答题时，确保脸部在摄像头监拍范围，清晰可见，系统会全程监拍！</div>'+cishuTip+"</div>",ok:function(){top.window.initPhotoShow();$(".monitorBox").addClass("heightLimited")},okText:"开启监拍"});top.surenext3()}console.log("get liveness result  failed...");ACMGlobal.liveNessResult=false}})}if(typeof top.ACMGlobal.kaoQian=="boolean"){$(".cxdialog_btns .btn_no").remove()}}else{console.log("get bizid failed...");ACMGlobal.liveNessResult=false}})}}