app.register("onlinecodeController",["$scope","$http","$state","$stateParams","$location","$timeout","App",function($scope,$http,$state,$stateParams,$location,$timeout,App){var editor,edtCSS,edtJs;$scope.private="-----BEGIN PRIVATE KEY-----MIICdwIBADANBgkqhkiG9w0BAQEFAASCAmEwggJdAgEAAoGBANF2K2iRtLDr48je3USa9kgYdt9zGYTraDno5bBleweOTgkfuXbViXvI4rLe4XTjPfQnXtsuY3Lj8TaejfvGo5a5TtGF5qJLWeiRdoNTXeF/T1//ubtjFwOA0NV2hk6fSZe9bj89VBjv7rGfZoCcwFRjeySWnKnsux5S3VAljOdfAgMBAAECgYEAmREV37C6rp9zMhNK9xuW5lCabegaufuditQbJbDDG15uwFQioCij84V1xOkDMPvvBkDPHLTlj8vrNdLgRyF94RBT9uOoaz67Ba/vBuRCuVdCAJzVuLYl5F2HVEFeLM5Qoe9q053UJynyMaSzWOtCX8cGgK9wcuBKg5QYOkcyfWECQQD0UzT5wX7S5PT5C2uzM5Zn9D6qOAgXwA6I426SFdYwLmwSfBmXoZBzSfwae7VxKiEocGsrW9V3S83MhP5Ce9htAkEA23h7upxTF2/nPhPyo7oujsvVHYn3evwoalHXp4K39KWdM/Q/YxL1SSvHHz48mzOdjZVc9ImUHjZl2Xoh8+63ewJAcGxJGBNdFBWeU2pZ6F94eeT9YL3fm24YQgzEuBusLwdtWyQXcpo5KZOFmXoLB0NndoAkEBN1qisLS2x2wojSEQJARh+9COch9X8f18nv4Th/38hpE8MdfAJNt4rm6PLvbA/upscH6dQI45RFT0pHex+G29I5nTjIRs8Cw/YuGw7POQJBAOhYBUAJLxV8q3Z+pRQnJPvm8DlFq4Fr75UTI9PPAvzLBhhwm9Yk64urUEwIGFP3tYusS0Tti2DJRmXJYzeI5OI=-----END PRIVATE KEY-----";$(".loadshow").removeClass("hide");$timeout(function(){selTab("onlinecode")});$("#navTab").hide();$scope.App=App;window.scrollTo(0,0);$scope.loading=false;$scope.model={};$scope.answer="";$scope.lang="";$scope.langText=ACM.lang.onlinecode.selectCodeLang;$scope.isPc=true;if(document.body.clientWidth<800){$scope.isPc=false}$scope.paperId=App.paperId=$stateParams.paperId;$scope.quesNo=App.quesNo=parseInt($stateParams.quesNo);$scope.direction=parseInt($stateParams.direction);$scope.debugInfoText="";$scope.runInfoText="";if(window.codeResultTimer){clearTimeout(window.codeResultTimer)}if(window.codeDebugTimer){clearTimeout(window.codeDebugTimer)}$scope.$on("main.submitAPaper",function(e,d){$scope.submitPaper()});$scope.$on("main.gotoQuestion",function(e,paperId,rowNumber){$scope.goToQuestion(paperId,rowNumber)});$scope.$on("timeOver.submitNow",function(e,d){console.log("timeOver.submitNow");$scope.autoSubmitPaper()});$scope.$on("practise.timeOver",function(e,d){console.log("practise.timeOver");gotoHash("#/main/rules");$(".noticeTips.forall").removeClass("forcode");$(".examtitle .titleright").remove()});$scope.autoSubmitPaper=function(rowNumber){$("#txtAnswer").val(editor.getValue());var ans=$scope.getAnswer();if(Object.isNullString(ans)){$http.post("/cand/api/addLog",{action:"answer",paperId:$scope.paperId,quesId:$scope.model.pqId}).success(function(data){}).error(function(data){});$http.post("/cand/api/addLog",{action:"submitPaper",paperId:$scope.paperId}).success(function(data){}).error(function(data){});App.submitAPaper($http,$state,$scope.paperId,function(r){if(App.serverTime.usedTime>=0){gotoHash("#/main/start")}else{gotoHash("#/main/practise")}})}else{if($scope.checkBeforSave(rowNumber)){$scope.saveAnswerAction(ans,$scope.lang,function(succ){if(succ){$.cxDialog.close();$http.post("/cand/api/addLog",{action:"submitPaper",paperId:$scope.paperId}).success(function(data){}).error(function(data){});$http.post("/cand/api/addLog",{action:"answer",paperId:$scope.paperId,quesId:$scope.model.pqId}).success(function(data){}).error(function(data){});App.submitAPaperDo($http,$state,$scope.paperId,function(r){if(App.serverTime.usedTime>=0){gotoHash("#/main/start")}else{gotoHash("#/main/practise")}})}})}}};$scope.submitPaper=function(rowNumber){$("#txtAnswer").val(editor.getValue());var ans=$scope.getAnswer();if(Object.isNullString(ans)){$http.post("/cand/api/addLog",{action:"answer",paperId:$scope.paperId,quesId:$scope.model.pqId}).success(function(data){}).error(function(data){});$http.post("/cand/api/addLog",{action:"submitPaper",paperId:$scope.paperId}).success(function(data){}).error(function(data){});App.submitAPaper($http,$state,$scope.paperId,function(r){if(App.serverTime.usedTime>=0){gotoHash("#/main/start")}else{gotoHash("#/main/practise")}})}else{if($scope.checkBeforSave(rowNumber)){var checkAnsSave=App.checkQuesSave();if(Object.isNullString(checkAnsSave)){$scope.saveAnswerAction(ans,$scope.lang,function(succ){if(succ){$http.post("/cand/api/addLog",{action:"submitPaper",paperId:$scope.paperId}).success(function(data){}).error(function(data){});$http.post("/cand/api/addLog",{action:"answer",paperId:$scope.paperId,quesId:$scope.model.pqId}).success(function(data){}).error(function(data){});App.submitAPaper($http,$state,$scope.paperId,function(r){if(App.serverTime.usedTime>=0){gotoHash("#/main/start")}else{gotoHash("#/main/practise")}})}})}else{cxalert(ACM.lang.hint,ACM.lang.onlinecode.queueSubmitted)}}}};$scope.goToQuestion=function(paperId,rowNumber){var ans=$scope.getAnswer();$scope.saveAnswerAction(ans,$scope.lang,function(){var strTo="answer";if(App.paper.forCode)strTo="onlinecode";gotoHash("#/main/{2}/{0}/{1}/0".Format(App.paper._id,rowNumber,strTo))})};$scope.next=function(rowNumber){$("#txtAnswer").val(editor.getValue());var ans=$scope.getAnswer();$scope.checkAnswer(ans);if($scope.checkPrevNext(rowNumber)){if($scope.getLangCount()>=2){$.cxDialog({title:ACM.lang.hint,background:"#000",width:400,info:'<div style="padding:20px; text-align:center;font-size:18px;">'+ACM.lang.onlinecode.manyLanguage.Format(CODE_LANG[$scope.lang])+"</div>",ok:function(){$scope.saveAnswerAction(ans,$scope.lang,function(){gotoHash("#/main/onlinecode/{0}/{1}/{2}".Format($scope.paperId,rowNumber,1))})},okText:ACM.lang.ok,no:function(){},noText:ACM.lang.no})}else{$scope.saveAnswerAction(ans,$scope.lang,function(){gotoHash("#/main/onlinecode/{0}/{1}/{2}".Format($scope.paperId,rowNumber,1))})}}};$scope.prev=function(rowNumber){$("#txtAnswer").val(editor.getValue());var ans=$scope.getAnswer();$scope.checkAnswer(ans);if($scope.checkPrevNext(rowNumber)){if($scope.getLangCount()>=2){$.cxDialog({title:ACM.lang.hint,background:"#000",width:400,info:'<div style="padding:20px; text-align:center;font-size:18px;">'+ACM.lang.onlinecode.manyLanguage.Format(CODE_LANG[$scope.lang])+"</div>",ok:function(){$scope.saveAnswerAction(ans,$scope.lang,function(){gotoHash("#/main/onlinecode/{0}/{1}/{2}".Format($scope.paperId,rowNumber,-1))})},okText:ACM.lang.ok,no:function(){},noText:ACM.lang.no})}else{$scope.saveAnswerAction(ans,$scope.lang,function(){gotoHash("#/main/onlinecode/{0}/{1}/{2}".Format($scope.paperId,rowNumber,-1))})}}};$scope.checkPrevNext=function(rowNumber){$("#txtAnswer").val(editor.getValue());var ans=$scope.getAnswer();if(!Object.isNullString(ans)){if(Object.isNullString($scope.lang)){cxalert(ACM.lang.hint,ACM.lang.onlinecode.noSelectLang);return false}else{return true}}else return true};$scope.checkBeforSave=function(rowNumber){$("#txtAnswer").val(editor.getValue());var ans=$scope.getAnswer();if(Object.isNullString($scope.lang)){cxalert(ACM.lang.hint,ACM.lang.onlinecode.noSelectLang);return false}else{if(Object.isNullString(ans)){cxalert(ACM.lang.hint,ACM.lang.onlinecode.noGiveAnswer);return false}else{return true}}};$scope.cbs=0;$scope.reportError=function(title,content){$http.post("/test/reportError",{url:title,error:content}).success(function(data,header,config,status){}).error(function(data,header,config,status){})};$scope.saveAnswerAction=function(ans,lang,callback,saveType){var rnd=$scope.cbs++;if(!Object.isNullString(ans)&&!Object.isNullString(lang)){App.ques.answer=ans;App.ques.lang=lang;{App.saveQues(App.paperId,App.ques,false);$http.post("/cand/api/addLog",{action:"answer",paperId:$scope.paperId,quesId:$scope.model.pqId}).success(function(data){}).error(function(data){});var postUrl="/cand/api/saveCodeAnswer";var postData={paperId:$scope.paperId,quesNo:$scope.model.rowNumber,ans:ans,lang:lang,web:getWebRenderHTML()};if($scope.model.ques.questype==100){if(saveType=="saveAndRun")postData.run="1";else postData.run="0";postUrl="/cand/api/savePrjFileContent";postData.filename=$("#txtAnswer").attr("filename")}(function(p,q,r){$http({url:postUrl,method:"post",data:postData}).then(function(resp){var data=resp.data,header=resp.headers,config=resp.config,status=resp.status;if(status!=200){cxalert(ACM.lang.hint,ACM.lang.onlinecode.requestFailed+status);return false}var blSucc=false;if(App.checkData(data,$state)){if(data&&data.code==1){blSucc=true}}else{}if(data.e){$scope.reportError(location.href,JSON.stringify({user:user,data:data}))}if(blSucc==false){if(data&&data.e==-11){cxalertBack(ACM.lang.hint,ACM.lang.answer.haveSubmited,function(){gotoHash("#/main/start")})}else if(data&&data.e==-12){cxalertBack(ACM.lang.hint,ACM.lang.answer.haveSubmited,function(){gotoHash("#/main/start")})}else if(data&&data.e==-13){cxalertBack(ACM.lang.hint,ACM.lang.answer.examEnd,function(){gotoHash("#/main/start")})}else if(data&&data.e==-15){location.href="/cand/index";return}else{cxalert(ACM.lang.hint,ACM.lang.onlinecode.queueSubmitted);$scope.reportError(location.href,JSON.stringify({user:user,resp:resp}))}}if(r==$scope.cbs-1||blSucc)App.saveQues(p,q,blSucc);$timeout(function(){if(r==$scope.cbs-1)callback(blSucc)});return},function(resp){var data=resp.data,header=resp.headers,config=resp.config,status=resp.status;if(r==$scope.cbs-1){cxalert(ACM.lang.hint,ACM.lang.onlinecode.queueSubmitted);App.saveQues(p,q,false);$timeout(callback)}App.updateFromServer($http,$state);$scope.reportError(location.href,JSON.stringify({type:"error",user:user,resp:resp}))})})(App.paperId,App.ques,rnd)}}else{if(rnd==$scope.cbs-1)$timeout(callback)}};$scope.getLangCount=function(){var langCodeCount=0;$("#lang li").each(function(){if(typeof App.ques["ans_"+App.ques._id+"_"+$(this).attr("value")]=="string"){langCodeCount++}});return langCodeCount};$scope.getResult=function(){$http.post("/cand/api/getCodeRunResult",{paperId:$scope.paperId,quesNo:$scope.model.rowNumber}).success(function(r){if(App.checkData(r,$state)){var data=r.r;console.log("data: "+data);var pr=r.r1;if(Object.isNullString(data))data=0;$timeout(function(){if(data<4){var strTxt=ARR_RUN_RESULT[data];if(data==3){if(r.pc!=null){strTxt+="("+r.pc.toFixed(2)+"%)"}}$(".mainbody .innerInfo .right .info .resultInfo .line2 .title > div.alert div.alert-warm").html(strTxt);if(data==2){$scope.debugInfoText=r.d;displayD(r.d,false)}if(window.codeResultTimer)clearTimeout(window.codeResultTimer);if(location.hash.startWith("#/main/onlinecode"))window.codeResultTimer=setTimeout($scope.getResult,2e3)}else{if(data==11){$(".mainbody .innerInfo .right .info .resultInfo .line2 .title > div.alert div.alert-warm").html("编译错误 Compile Error ...");$scope.getDebugInfo(r)}else{var t="";var inf="";if(pr==1){t="恭喜，编译成功并运行通过（Accepted）";inf=ACM.lang.onlinecode.accepted}else if(pr==0&&data==6){t="您的程序输出结果错误 Wrong Answer";inf=ACM.lang.onlinecode.wrongAnswer}else{t=ARR_RUN_RESULT[data];inf=ACM.lang.onlinecode.acRate.Format((pr*100).toFixed(0));if(data==7){inf+=ACM.lang.onlinecode.codingTips}}$(".mainbody .innerInfo .right .info .resultInfo .line2 .title > div.alert div.alert-warm").html(t);if($scope.model.ques.questype==100){$scope.runInfoText=r.d;displayD(["[Compile Info]",$scope.debugInfoText,"[Test Info]",$scope.runInfoText].join("\n"),false)}else{$(".openView .infolist").html(inf);if(pr==0&&data==6){$(".openView .infolist").append('<div style="margin-top:40px;">'+ACM.lang.onlinecode.noACTip+"</div>")}}}}if(1==0){var txt=ARR_RUN_RESULT[data];if(data==6)txt="您的程序输出结果错误 Wrong Answer";if(data==7){txt+=ACM.lang.onlinecode.codingTips}if(data==10)txt="您的程序在运行时发生错误  Runtime Error";$(".mainbody .innerInfo .right .info .resultInfo .line2 .title > div.alert div.alert-warm").html(txt)}});return}else{}}).error(function(data){console.log("Error: "+data)})};var displayD=function(di,blAppend,blClear){$timeout(function(){var h=null;if(blClear==false)h=$(".openView .infolist").append(di.HTMLEncode().TextToHtml());else h=$(".openView .infolist").html(di.HTMLEncode().TextToHtml());if(blAppend!=false)h.append('<div style="margin-top:40px;">'+ACM.lang.onlinecode.noACTip+"</div>");h.scrollTop(h[0].scrollHeight)})};$scope.getDebugInfo=function(d){var getD=function(){$http.post("/cand/api/getCodeDebugInfo",{paperId:$scope.paperId,quesNo:$scope.model.rowNumber,r:Math.random()}).success(function(data){if(App.checkData(data,$state)){if(data){if(data.h==true){displayD(data.d)}else{if(window.codeDebugTimer)clearTimeout(window.codeDebugTimer);window.codeDebugTimer=setTimeout(function(){$scope.getDebugInfo({})},2e3)}}}else{}}).error(function(data){console.log("Error: "+data)})};if(d){if(d.h==true){displayD(d.d)}else{getD()}}};$scope.debugTimeCheck=function(){if($(".mainbody .innerInfo .right .info .resultInfo .line2 .title .buttom").hasClass("limited")){return 0}if(typeof ACMGlobal!="undefined"){if(ACMGlobal.debugLimitTime==15){var debugTimer=window.setInterval(function(){if(ACMGlobal.debugLimitTime>0){$(".debugbuttom").html(ACM.lang.onlinecode.debug+"（"+ACMGlobal.debugLimitTime+"s）").addClass("limited");$(".mainbody .innerInfo .right .info .resultInfo .line2 .title .buttom").html('<i class="fa fa-play-circle-o"></i>  '+ACM.lang.onlinecode.run+"（"+ACMGlobal.debugLimitTime+"s）").addClass("limited");ACMGlobal.debugLimitTime--}else{$(".debugbuttom").html(ACM.lang.onlinecode.debug).removeClass("limited");$(".mainbody .innerInfo .right .info .resultInfo .line2 .title .buttom").html('<i class="fa fa-play-circle-o"></i>  '+ACM.lang.onlinecode.run).removeClass("limited");window.clearInterval(debugTimer);ACMGlobal.debugLimitTime=15}},1e3);$(".debugbuttom").html(ACM.lang.onlinecode.debug+"（"+ACMGlobal.debugLimitTime+"s）").addClass("limited");$(".mainbody .innerInfo .right .info .resultInfo .line2 .title .buttom").html('<i class="fa fa-play-circle-o"></i>  '+ACM.lang.onlinecode.run+"（"+ACMGlobal.debugLimitTime+"s）").addClass("limited");return 1}else if(ACMGlobal.debugLimitTime>0&&ACMGlobal.debugLimitTime<15){return 0}else{ACMGlobal.debugLimitTime=15;return 1}}};$scope.saveAnswer=function(rowNumber){if($scope.checkBeforSave(rowNumber)){if($scope.debugTimeCheck()==0){return}$(".mainbody .innerInfo .right .info .resultInfo .line2 .title > div.alert div.alert-warm").html(ACM.lang.onlinecode.savingAns);$scope.saveAnswerAction($scope.getAnswer(),$scope.lang,function(){$(".mainbody .innerInfo .right .info .resultInfo .line2 .title > div.alert div.alert-warm").html("正在编译 Compiling");$(".openView .infolist").html("");setTimeout(function(){$scope.getResult()},2e3)},"saveAndRun")}};$scope.saveAnswerExt=function(rowNumber){if($scope.checkBeforSave(rowNumber)){if($scope.getLangCount()>=2){$.cxDialog({title:ACM.lang.hint,background:"#000",width:400,info:'<div style="padding:20px; text-align:center;font-size:18px;">'+ACM.lang.onlinecode.manyLanguage.Format(CODE_LANG[$scope.lang])+"</div>",ok:function(){$scope.saveAnswerAction($scope.getAnswer(),$scope.lang,function(succ){if(succ)cxalert(ACM.lang.hint,ACM.lang.onlinecode.saveCodeSuccess)})},okText:ACM.lang.ok,no:function(){},noText:ACM.lang.no})}else{$scope.saveAnswerAction($scope.getAnswer(),$scope.lang,function(succ){if(succ)cxalert(ACM.lang.hint,ACM.lang.onlinecode.saveCodeSuccess)})}}};$scope.checkAnswer=function(ans){if(Object.isNullString(ans))cxalert(ACM.lang.hint,ACM.lang.onlinecode.noGiveAnswer);else return true};function getWebRenderHTML(){var html=[];if($scope.lang==20){html.push("<html><head><title>ACMcoder HTML Render</title>");html.push("<style>");html.push(edtCSS.getValue());html.push("</style>");html.push('<script language="javascript" src="');html.push("https://cdn.acmcoder.com/assets/public/assets/js/jquery/jquery-1.11.3.min.js");html.push('"><\/script>');html.push("</head>");html.push("<body>");html.push(editor.getValue());html.push('<script language="javascript">');html.push(edtJs.getValue());html.push("<\/script>");html.push("</body>");html.push("</html>")}return html.join("")}$scope.getAnswer=function(){if($scope.lang==20){$("#txtAnswer").val(editor.getValue());$("#txtA2").val(edtCSS.getValue());$("#txtA3").val(edtJs.getValue());ans=JSON.stringify({html:$("#txtAnswer").val(),css:$("#txtA2").val(),js:$("#txtA3").val()})}else{$("#txtAnswer").val(editor.getValue());var ans="";if($scope.model.ques){switch($scope.model.ques.questype){case 6:case 100:ans=$("#txtAnswer").val();break}}if($scope.model.ques.usetemp==true)$scope.model["ans_"+$scope.model._id+"_"+$scope.lang]=ans}return ans};$scope.getLang=function(){var ans="";if($scope.lang=""){return ACM.lang.onlinecode.selectCodeLang}else{return $scope.lang}};$scope.displayLang=function(){var ans="";if($scope.model.ques){switch($scope.model.ques.questype){case 6:case 100:ans=$("#lang").val();break}}return ans};$scope.initPrjStruc=function(){$("#tree").jstree({core:{data:function(obj,callback){$http({url:"/cand/api/getPrjStructure",method:"post",data:{paperId:$scope.paperId,quesNo:$scope.model.rowNumber}}).then(function(resp){var data=resp.data,header=resp.headers,config=resp.config,status=resp.status;function folderNode(id,text){var node={text:text,children:[],id:id,icon:"folder",childs:{},state:{opened:true}};return node}function fileNode(id,text){var node={text:text,children:false,id:id,type:"file",icon:"file file-ew node"};return node}var childs={childs:{},children:[]};for(var i=0;i<data.length;i++){var fn=data[i].filename;var fns=fn.split("/");var node=fileNode(fn,fns[fns.length-1]);if(fns.length>1){var obj=childs;var np="";for(var j=0;j<fns.length-1;j++){var nn=fns[j];if(j>0)np+="/";np+=nn;var nnn=obj.childs[np];if(nnn==null){nnn=folderNode(np,nn);obj.childs[np]=nnn;obj.children.push(nnn)}obj=nnn}obj.childs[fn]=node;obj.children.push(node)}else{childs.childs[fns[0]]=node;childs.children.push(node)}}console.log(childs);callback.call(this,[{text:"ACMcoder",children:childs.children,id:"/",icon:"folder",state:{opened:true,disabled:true}}])},function(resp){var data=resp.data,header=resp.headers,config=resp.config,status=resp.status})},check_callback:function(o,n,p,i,m){if(m&&m.dnd&&m.pos!=="i"){return false}if(o==="move_node"||o==="copy_node"){if(this.get_node(n).parent===this.get_node(p).id){return false}}return true},themes:{responsive:false,variant:"small",stripes:true}},sort:function(a,b){return this.get_type(a)===this.get_type(b)?this.get_text(a)>this.get_text(b)?1:-1:this.get_type(a)>=this.get_type(b)?1:-1},contextmenu:{items:function(node){var tmp=$.jstree.defaults.contextmenu.items();delete tmp.create.action;tmp.create.label="New";tmp.create.submenu={create_folder:{separator_after:true,label:"Folder",action:function(data){var inst=$.jstree.reference(data.reference),obj=inst.get_node(data.reference);inst.create_node(obj,{type:"default"},"last",function(new_node){setTimeout(function(){inst.edit(new_node)},0)})}},create_file:{label:"File",action:function(data){var inst=$.jstree.reference(data.reference),obj=inst.get_node(data.reference);inst.create_node(obj,{type:"file"},"last",function(new_node){setTimeout(function(){inst.edit(new_node)},0)})}}};if(this.get_type(node)==="file"){delete tmp.create}return tmp}},types:{default:{icon:"folder"},file:{valid_children:[],icon:"file"}},unique:{duplicate:function(name,counter){return name+" "+counter}},plugins:["state","dnd","sort","types","contextmenu","unique"]}).on("delete_node.jstree",function(e,data){$.get("?operation=delete_node",{id:data.node.id}).fail(function(){data.instance.refresh()})}).on("create_node.jstree",function(e,data){$.get("?operation=create_node",{type:data.node.type,id:data.node.parent,text:data.node.text}).done(function(d){data.instance.set_id(data.node,d.id)}).fail(function(){data.instance.refresh()})}).on("rename_node.jstree",function(e,data){$.get("?operation=rename_node",{id:data.node.id,text:data.text}).done(function(d){data.instance.set_id(data.node,d.id)}).fail(function(){data.instance.refresh()})}).on("move_node.jstree",function(e,data){$.get("?operation=move_node",{id:data.node.id,parent:data.parent}).done(function(d){data.instance.refresh()}).fail(function(){data.instance.refresh()})}).on("copy_node.jstree",function(e,data){$.get("?operation=copy_node",{id:data.original.id,parent:data.parent}).done(function(d){data.instance.refresh()}).fail(function(){data.instance.refresh()})}).on("changed.jstree",function(e,data){if(data&&data.selected&&data.selected.length){$.post("api/getContent",{paperId:$scope.paperId,quesNo:$scope.model.rowNumber,filename:data.selected[0]},function(d){if(d){$("#txtAnswer").attr("filename",data.selected[0]).val(d.content);if(editor){editor.setValue($("#txtAnswer").val());editor.refresh()}}})}else{}})};var refreshFunc=function(){{App.paper=App.getPaper($scope.paperId);App.Papers=[App.paper];if(App.paper==null){cxalert(ACM.lang.hint,ACM.lang.answer.paperSending);$timeout(function(){gotoHash("#/main/rules")});return}var idx=0;if($scope.quesNo>-1){if($scope.direction>0)idx=App.quesNo/100+1;else if($scope.direction<0)idx=App.quesNo/100-1;else idx=App.quesNo/100}var data=App.getQues($scope.paperId,idx*100);if(data==null){cxalert(ACM.lang.hint,ACM.lang.answer.quesSending,function(){gotoHash("#/main/start")});$timeout(function(){gotoHash("#/main/rules")});return}data.code=0;data.paper=App.paper;App.ques=data;App.paperAns=App.getPapersAllAns(App.paperId);for(var i=0;i<App.paperAns.length;i++){delete App.paperAns[i].$$hashKey}$scope.model=data;App.rowNumber=data.rowNumber;if($scope.model.ques.fenzhi.toString().length>5){$scope.model.ques.fenzhi=$scope.model.ques.fenzhi.toString().substring(0,$scope.model.ques.fenzhi.toString().indexOf(".")+2)}if($scope.model.ques.inputSample!=undefined){$scope.model.ques.inputSample=$scope.model.ques.inputSample.replace(/<br>/g,"<br />")}if($scope.model.ques.outputSample!=undefined){$scope.model.ques.outputSample=$scope.model.ques.outputSample.replace(/<br>/g,"<br />")}$http.post("/cand/api/addLog",{action:"enterQues",paperId:App.paperId,quesId:$scope.model.pqId}).success(function(data){}).error(function(data){});$scope.loading=false;$timeout(function(){if($scope.model.ques){if($scope.model.ques.questype==100){$scope.initPrjStruc()}if(!Object.isNullString($scope.model.answer)){switch($scope.model.ques.questype){case 6:case 100:if($scope.model.lang!=20)$("#txtAnswer").val($scope.model.answer);$scope.lang=$scope.model.lang;if($scope.lang>-1)$scope.langText=CODE_LANG[$scope.lang];$scope.model["ans_"+$scope.model._id+"_"+$scope.lang]=$scope.model.answer;break}}}if($scope.model.paper.allQuesPanel!=0){$(".nav .examlist").attr("data-step","4").attr("data-intro",$(".nav .examlist").attr("data-intro1")).show()}else{$(".nav .examlist").removeAttr("data-step").removeAttr("data-intro")}$("li.onlineRefer").attr("data-position","top");function createEditor(id){return CodeMirror.fromTextArea(document.getElementById(id),{mode:"scheme",styleActiveLine:true,lineNumbers:true,matchBrackets:true,highlightSelectionMatches:{showToken:/\w/},indentUnit:4,extraKeys:{"Ctrl-0":"autocomplete"}})}var initEditor=function(){editor=createEditor("txtAnswer");editor.on("inputRead",function(){editor.showHint()});var pending;editor.on("change",function(){clearTimeout(pending);pending=setTimeout(update,400)});function looksLikeScheme(code){return!/^\s*\(\s*function\b/.test(code)&&/^\s*[;\(]/.test(code)}function update(){editor.setOption("mode",looksLikeScheme(editor.getValue())?"scheme":"javascript");editor.refresh()}function update2(){edtJs.setOption("mode",looksLikeScheme(editor.getValue())?"scheme":"javascript");edtJs.refresh()}$(".mianall .mainbody .innerInfo .stepinfo .left .info .webtitle").html($(".mianall .mainbody .innerInfo .examtitle .titleleft .title").html()).find(".examtype").addClass("small").removeClass("examtype");updateEditorHeight();update();$(".myCalculator").hide();$(".mainbody .innerInfo .right .info .resultInfo .btn-hide-run-pane").click(function(){$(".mainbody .innerInfo .right .info .resultInfo .line2 .title > div.alert div.alert-warm").html("");$(".openView .infolist").html("");$(".mainbody .innerInfo .right .info .resultInfo").removeClass("openView").animate({right:-505},500,function(){$(".mainbody .innerInfo .right .info .resultInfo").hide()})});$(".editorbanner a.debugbuttom").click(function(){if(typeof ACMGlobal!="undefined"){if(ACMGlobal.debugLimitTime>0&&ACMGlobal.debugLimitTime<15){return}}$(".mainbody .innerInfo .right .info .resultInfo").show().animate({right:0},500,function(){});$(".mainbody .innerInfo .right .info .resultInfo .line2 .title > div.alert div.alert-warm").html("");$(".resultInfo .infolist").html("");if(!$(".mainbody .innerInfo .right .info .resultInfo").hasClass("openView")){$(".mainbody .innerInfo .right .info .resultInfo").addClass("openView")}});$(".resultInfo .line2 .title .buttom").click(function(){if(typeof ACMGlobal!="undefined"){if(ACMGlobal.debugLimitTime>0&&ACMGlobal.debugLimitTime<15){return}}});$(".toollist .fullscreen").click(function(){if(!$(".CodeMirror").hasClass("CodeMirror-fullscreen")){$(".mainbody .innerInfo .right").css("width","100%").css("position","absolute").css("left","0%");$(".mainbody .innerInfo .left").css("width","0%");$(".mainbody .innerInfo .left .info").hide();$(".CodeMirror").addClass("CodeMirror-fullscreen");$(".toollist .fullscreen").removeClass("fa-arrows-alt").addClass("fa-arrows")}else{$(".mainbody .innerInfo .right").attr("style","");$(".mainbody .innerInfo .left").css("width","40%");$(".mainbody .innerInfo .left .info").show();$(".CodeMirror").removeClass("CodeMirror-fullscreen");$(".toollist .fullscreen").removeClass("fa-arrows").addClass("fa-arrows-alt")}resetCodeMirrorHeightFun()});$(".toollist .indent").click(function(){indentLine()});function indentLine(){if($scope.lang==6){editor.setOption("mode","python")}var doc=editor.getDoc();editor.operation(function(){for(var i=0;i<doc.lineCount();i++){editor.indentLine(i)}})}$(window).resize(function(){resetCodeMirrorHeightFun()});var resetCodeMirrorHeightFun=function(){var langInfoHeight=0;if($(".viewLangInfo").css("display")=="block"){langInfoHeight=20+$(".viewLangInfo").height()}$(".CodeMirror").css("height",$(".innerInfo .right .info").height()-langInfoHeight-115);$(".codeInfo").css("height",$(".innerInfo .right .info").height()-langInfoHeight-115).css("margin-top",langInfoHeight);update()};var resetCodeMirrorHeightFun2=function(type){var langInfoHeight=$(".viewLangInfo").height()+20;if(type!=1){$(".CodeMirror").css("height",$(".innerInfo .right .info").height()-163);$(".codeInfo").css("height",$(".innerInfo .right .info").height()-163);$(".codeInfo").css("margin-top",langInfoHeight)}else{$(".CodeMirror").css("height",$(".innerInfo .right .info").height()-115);$(".codeInfo").css("height",$(".innerInfo .right .info").height()-115)}update2()};if($scope.model.ques.temps!=undefined){$scope.model.ques.usetemp=true}var langTextClick=function(){var gettyle=$(this).html();var newLang=$(this).attr("value");if($scope.lang!=newLang){if($scope.model.ques.temps!=undefined){if($scope.model.ques.temps["l"+newLang]==undefined){$(".refreshTemp").hide()}else{$(".refreshTemp").show()}var ans=$scope.getAnswer();if(!Object.isNullString(ans))$scope.model["ans_"+$scope.model._id+"_"+$scope.lang]=ans;var ma=$scope.model["ans_"+$scope.model._id+"_"+newLang];if(!Object.isNullString(ma)){$scope.model.answer=ma}else{$scope.model.answer=$scope.model.ques.temps["l"+newLang]}$("#txtAnswer").val($scope.model.answer);editor.setValue($("#txtAnswer").val())}$scope.lang=newLang;$scope.langText=gettyle;$scope.$apply()}for(var i=0;i<ACMGlobalData.versionInfo.length;i++){if(parseInt(newLang)==ACMGlobalData.versionInfo[i].lang){$(".programmingNotes span").html(ACM.lang.onlinecode.compilerVersion+ACMGlobalData.versionInfo[i].version);console.log("load code info ext.");if(ACMGlobalData.versionInfo[i].info==""){$(".viewLangInfo span").html("");$(".viewLangInfo").addClass("hide");resetCodeMirrorHeightFun();$(".versionInfo").hide()}else{$(".viewLangInfo span").html(ACMGlobalData.versionInfo[i].info);$(".viewLangInfo").removeClass("hide");$(".versionInfo").addClass("fa-caret-up").removeClass("fa-caret-down").find("span").html(ACM.lang.onlinecode.hide);$(".versionInfo").show();resetCodeMirrorHeightFun()}}}$("#lang").attr("selectValue",newLang)};$(".refresh .fa-refresh").unbind("click").bind("click",function(){var newLang=$scope.lang;$scope.model.answer=$scope.model.ques.temps["l"+newLang];$("#txtAnswer").val($scope.model.answer);editor.setValue($("#txtAnswer").val())});if($(".tipinfo").length==0){$(".qnumb_qums").after('<div class="tipinfo"><div class="info clearfix"><div class="fr light"></div><span class="tip">'+ACM.lang.main.tip+"span><br><span>"+ACM.lang.answer.carefullyRead+"</span></div></div>")}$(".viewLangInfo a.closeBtn").unbind("click").bind("click",function(){if($(".viewLangInfo span").html()!=""){$(".viewLangInfo").addClass("hide");$(".versionInfo").addClass("fa-caret-down").removeClass("fa-caret-up").find("span").html(ACM.lang.onlinecode.show);resetCodeMirrorHeightFun()}});$(".versionInfo").unbind("click").bind("click",function(){if($(".viewLangInfo span").html()!=""){if($(".viewLangInfo").hasClass("hide")){$(".viewLangInfo").removeClass("hide");$(".versionInfo").addClass("fa-caret-up").removeClass("fa-caret-down").find("span").html(ACM.lang.onlinecode.hide)}else{$(".viewLangInfo").addClass("hide");$(".versionInfo").addClass("fa-caret-down").removeClass("fa-caret-up").find("span").html(ACM.lang.onlinecode.show)}resetCodeMirrorHeightFun()}});var ll=$scope.model.ques.allowlangs;if(ll==null||ll=="")ll=DEFCODELANGS;var lls=ll.split(",");$("#lang li").unbind("click",langTextClick);var llt=[];for(var i=0;i<lls.length;i++){llt.push('<li value="{0}" $code_{0}>{1}</li>'.Format(lls[i],CODELANGS[lls[i]]))}$("#lang").html(llt.join("\n"));$("#lang li").bind("click",langTextClick);$("#lang li").each(function(){if($(this).attr("value")==$scope.lang){$(this).click()}});if(ll.indexOf("20")>-1){$("#lang").attr("selectValue","20");$scope.lang=20;$("#fhtml").addClass("sel");edtCSS=createEditor("txtA2");edtJs=createEditor("txtA3");var lt=Object.isNullString($scope.model.answer)?$scope.model.ques.temps["l20"]:$scope.model.answer;if(!Object.isNullString(lt)){lt=JSON.parse(lt);$("#txtAnswer").val(lt.html);editor.setValue($("#txtAnswer").val());$("#txtA2").val(lt.css);edtCSS.setValue($("#txtA2").val());$("#txtA3").val(lt.js);edtJs.setValue($("#txtA3").val());updateEditorHeight();editor.refresh();edtCSS.refresh();edtJs.refresh()}$(".fweb").unbind("click").bind("click",function(){$(".fweb").removeClass("sel");$(this).addClass("sel");$(".feditor").hide();$("#e"+this.id).show();if(this.id=="frend"){$("#webrender").html('<iframe id="ifmRender" border="0" frameborder="0" style="width:100%;height:100%"></iframe>');var ifm=$("#ifmRender");var iframeDoc=ifm.get(0).contentDocument||ifm.get(0).contentWindow.document;var iframeWin=ifm.defaultView||ifm.parentWindow;iframeDoc.open("text/html","replace");iframeDoc.write(getWebRenderHTML());iframeDoc.close()}else{editor.refresh();edtCSS.refresh();edtJs.refresh()}if($(this).attr("id")=="fjs"){$(".viewLangInfo").remove();$("#forOther").after('<div class="viewLangInfo" style=""><table><tbody><tr><td><span><li>'+ACM.lang.onlinecode.es6Tip+' </li></span></td><td><a class="closeBtn"><i class="fa fa-times-circle"></i></a></td></tr></tbody></table></div>');resetCodeMirrorHeightFun2(0);$(".viewLangInfo a.closeBtn").unbind("click").bind("click",function(){$(".viewLangInfo").addClass("hide");$(".codeInfo").removeAttr("style");resetCodeMirrorHeightFun2(1)})}else{$(".viewLangInfo").remove();$(".codeInfo").removeAttr("style");resetCodeMirrorHeightFun2(1)}});$("#forOther").hide();$("#forWeb").show()}else{$("#forOther").show();$("#forWeb").hide();resetCodeMirrorHeightFun()}function updateEditorHeight(){var wHeight=0;wHeight=$(window).height();$(".CodeMirror").css("height",wHeight-195)}if($scope.lang==""){$("#lang li:first-child").click()}$(".examtitle").hide();$(".titlename ul").hide();$(".titlename").bind("click",function(){$(".titlename ul").toggle(200)});if(App.myInfo&&!Object.isNullString(App.myInfo.codeComment))$("#codeComment").html(App.myInfo.codeComment).fadeIn("slow");else $("#codeComment").html("").hide();$scope.$apply();editor.refresh();$(".loadshow").addClass("hide")};if(typeof CodeMirror=="undefined"){forCode.push(initEditor)}else{initEditor()}$(".codeshow").css("opacity",1);window.ACM.loadIntroJs=function(){$(".noticeTips").show();if($(".onlineRefer.mianli").length>0){if($.cookie("introJsforcode")==null&&isMobile==false&&$scope.model.ques.allowlangs!="20"){$.cookie("introJsforcode","1");if($scope.model.forPractise==$scope.model.forPractise&&$scope.model.rowNumber==0){var introMask=function(){if(!$(".mianall").hasClass("forcode")){$(".mianall").addClass("forcode")}introJs().setOptions({doneLabel:ACM.lang.iknow,nextLabel:ACM.lang.iknow,showBullets:false,showStepNumbers:false,tooltipPosition:"auto",exitOnOverlayClick:false}).start().oncomplete(function(){$.cxDialog.defaults.background="#000";$.cxDialog({title:ACM.lang.hint,info:ACM.lang.onlinecode.showTip,ok:function(){},okText:ACM.lang.iknow})})};if(typeof introJs=="undefined")bundles.push(introMask);else introMask()}}}else{$timeout(function(){if(window.ACM.loadIntroJs){window.ACM.loadIntroJs()}},1e3)}};window.ACM.loadIntroJs()});App.updateFromServer($http,$state);App.updatePaperServer($http,App.paper._id);$timeout(function(){$(".wave .first").html(parseInt($scope.model.rowNumber/100)+1);$(".wave .total").html(App.paper.quesNum)})}};$scope.refreshFunc=refreshFunc;refreshFunc();function setEditorValue(e,v){}window.onfocus=function(){$http.post("/cand/api/focusLog",{paperId:$scope.paperId,quesNo:$scope.model.rowNumber,focus:"CODE_FOCUS"}).success(function(data){}).error(function(data){console.log(data)})}}]);